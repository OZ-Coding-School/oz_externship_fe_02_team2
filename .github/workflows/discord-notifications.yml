name: Discord Notifications

on:
  pull_request:
    types: [opened, review_requested, closed]
  pull_request_review:
    types: [submitted]

env:
  WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      # PR ìƒì„± ì•Œë¦¼
      - name: Notify on PR Opened
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;

            const payload = {
              embeds: [{
                title: "ğŸ†• ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!",
                description: `[${pr.title}](${pr.html_url})`,
                color: 3447003,
                fields: [
                  { name: "ğŸ‘¤ ì‘ì„±ì", value: pr.user?.login ?? "unknown", inline: true },
                  { name: "ğŸŒ¿ ë¸Œëœì¹˜", value: `\`${pr.head.ref}\` â†’ \`${pr.base.ref}\``, inline: true },
                  { name: "ğŸ“Š ë³€ê²½ì‚¬í•­", value: `+${pr.additions ?? 0} -${pr.deletions ?? 0}`, inline: true },
                ],
                timestamp: pr.created_at
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # ì—¬ëŸ¬ ë¦¬ë·°ì–´ ë©˜ì…˜ (ì¤‘ë³µ ë°©ì§€ í¬í•¨)
      - name: Mention Reviewers (on review_requested)
        if: github.event_name == 'pull_request' && github.event.action == 'review_requested'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;

            // ìš”ì²­ëœ ì „ì²´ ë¦¬ë·°ì–´ ëª©ë¡ê³¼ í˜„ì¬(íŠ¸ë¦¬ê±°) ë¦¬ë·°ì–´
            const reviewers = (pr.requested_reviewers ?? []).map(u => u.login);
            const current = context.payload.requested_reviewer?.login ?? null;
            const first = reviewers[0] ?? null;

            // ì²« ë²ˆì§¸ ë¦¬ë·°ì–´ë§Œ ì•Œë¦¼ ì „ì†¡ (ì¤‘ë³µ ë°©ì§€)
            if (first && current && current !== first) {
              core.info(`Skip: ${current} is not the first reviewer (${first}).`);
              return;
            }

            // GitHub login -> Discord mention ë§¤í•‘
            const mapMention = (login) => ({
              "chen4023": "<@683563560063991848>",
              "Kwonyeojiny": "<@579296258091646976>",
              "wrongstory": "<@256645987638968320>",
              "minjekim64": "<@595553015990059009>",
              "rlaalsckd4": "<@704883949146472449>",
              "makee-ham": "<@534334882512633862>",
              "shin-minhyuk": "<@1121074841102069814>",
            }[login] ?? `@${login}`);

            // ë©˜ì…˜ ëª©ë¡ (ìš”ì²­ëœ ë¦¬ë·°ì–´ê°€ ì—†ìœ¼ë©´ current ì‚¬ìš©)
            const targetLogins = reviewers.length ? reviewers : (current ? [current] : []);
            if (!targetLogins.length) {
              core.info("No reviewers to notify.");
              return;
            }
            const mentions = targetLogins.map(mapMention).join(" ");

            const payload = {
              content: `ğŸ” **ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!** ${mentions}`,
              embeds: [{
                title: "ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ‘€",
                description: `[${pr.title}](${pr.html_url})`,
                color: 16776960,
                fields: [
                  { name: "ğŸ‘¤ PR ì‘ì„±ì", value: pr.user?.login ?? "unknown", inline: true },
                  { name: "ğŸ“ ë³€ê²½ì‚¬í•­", value: `íŒŒì¼ ${pr.changed_files ?? 0}ê°œ | +${pr.additions ?? 0} -${pr.deletions ?? 0}`, inline: false },
                ],
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # PR ë³‘í•©/ë‹«í˜ ì•Œë¦¼
      - name: Notify on PR Closed
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;

            const merged = !!pr.merged;
            const statusTitle = merged ? "âœ… ë³‘í•© ì™„ë£Œ!" : "âŒ PR ë‹«í˜";
            const emoji = merged ? "ğŸ‰" : "ğŸš«";
            const color = merged ? 65280 : 16711680;

            const payload = {
              embeds: [{
                title: `${emoji} ${statusTitle}`,
                description: `[${pr.title}](${pr.html_url})`,
                color,
                fields: [
                  { name: "ğŸ‘¤ ì‘ì„±ì", value: pr.user?.login ?? "unknown", inline: true },
                  { name: "ğŸŒ¿ ë¸Œëœì¹˜", value: `\`${pr.head.ref}\` â†’ \`${pr.base.ref}\``, inline: true },
                ],
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # ë¦¬ë·° ìŠ¹ì¸ ì•Œë¦¼
      - name: Notify on Review Approved
        if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;
            const review = context.payload.review;

            const mapMention = (login) => ({
              "chen4023": "<@683563560063991848>",
              "Kwonyeojiny": "<@579296258091646976>",
              "wrongstory": "<@256645987638968320>",
              "minjekim64": "<@595553015990059009>",
              "rlaalsckd4": "<@704883949146472449>",
              "makee-ham": "<@534334882512633862>",
              "shin-minhyuk": "<@1121074841102069814>",
            }[login] ?? `@${login}`);

            const authorMention = mapMention(pr.user?.login ?? "unknown");

            const payload = {
              content: `ğŸ‘ **ë¦¬ë·°ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!** ${authorMention}`,
              embeds: [{
                title: "âœ… ë¦¬ë·° ìŠ¹ì¸ ì™„ë£Œ!",
                description: `[${pr.title}](${pr.html_url})`,
                color: 65280,
                fields: [
                  { name: "ğŸ‘€ ë¦¬ë·°ì–´", value: review.user?.login ?? "unknown", inline: true },
                  { name: "ğŸ’¬ ë¦¬ë·° ë‚´ìš©", value: "ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!", inline: false },
                ],
                footer: { text: "ì´ì œ ë³‘í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€" }
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # ë³€ê²½ ìš”ì²­ ì•Œë¦¼
      - name: Notify on Changes Requested
        if: github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;
            const review = context.payload.review;

            const mapMention = (login) => ({
              "chen4023": "<@683563560063991848>",
              "Kwonyeojiny": "<@579296258091646976>",
              "wrongstory": "<@256645987638968320>",
              "minjekim64": "<@595553015990059009>",
              "rlaalsckd4": "<@704883949146472449>",
              "makee-ham": "<@534334882512633862>",
              "shin-minhyuk": "<@1121074841102069814>",
            }[login] ?? `@${login}`);

            const authorMention = mapMention(pr.user?.login ?? "unknown");

            const payload = {
              content: `ğŸ”„ **ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!** ${authorMention}`,
              embeds: [{
                title: "â— ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤",
                description: `[${pr.title}](${pr.html_url})`,
                color: 16776960,
                fields: [
                  { name: "ğŸ‘€ ë¦¬ë·°ì–´", value: review.user?.login ?? "unknown", inline: true },
                  { name: "ğŸ“ ìš”ì²­ì‚¬í•­", value: "ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ PRì„ í™•ì¸í•´ì£¼ì„¸ìš”.", inline: false },
                ],
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
