name: Discord Notifications

on:
  pull_request:
    types: [opened, review_requested, closed]
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ['CI']
    types: [completed]
env:
  WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      # PR ìƒì„± ì•Œë¦¼
      - name: Notify on PR Opened
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;

            const payload = {
              embeds: [{
                title: "ğŸ†• ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!",
                description: `[${pr.title}](${pr.html_url})`,
                color: 3447003,
                fields: [
                  { name: "ğŸ‘¤ ì‘ì„±ì", value: pr.user?.login ?? "unknown", inline: true },
                  { name: "ğŸŒ¿ ë¸Œëœì¹˜", value: `\`${pr.head.ref}\` â†’ \`${pr.base.ref}\``, inline: true },
                  { name: "ğŸ“Š ë³€ê²½ì‚¬í•­", value: `+${pr.additions ?? 0} -${pr.deletions ?? 0}`, inline: true },
                ],
                timestamp: pr.created_at
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # PR ì‘ì—…ë‚´ìš©(ì»¤ë°‹/ë³€ê²½íŒŒì¼) ìš”ì•½ ì•Œë¦¼
      - name: Notify Work Summary (on opened/synchronize/edited)
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'edited')
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;

            // ì»¤ë°‹/íŒŒì¼ ëª©ë¡ ì¡°íšŒ
            const commitsRes = await github.rest.pulls.listCommits({
              owner, repo, pull_number: pr.number, per_page: 100
            });
            const filesRes = await github.rest.pulls.listFiles({
              owner, repo, pull_number: pr.number, per_page: 300
            });

            // ì»¤ë°‹ ìš”ì•½ (ìƒìœ„ 8ê°œ)
            const commits = commitsRes.data || [];
            const maxCommits = 8;
            const commitLines = commits
              .map(c => `- ${c.commit.message.split('\n')[0]} (${c.sha.slice(0,7)})`)
              .slice(0, maxCommits)
              .join('\n');
            const extraCommits = commits.length > maxCommits ? `\nâ€¦ì™¸ ${commits.length - maxCommits}ê±´` : '';

            // ë³€ê²½ íŒŒì¼ ëª©ë¡ (ìƒìœ„ 10ê°œ)
            const files = filesRes.data || [];
            const maxFiles = 10;
            const fileLines = files
              .slice(0, maxFiles)
              .map(f => `- ${f.filename}`)
              .join('\n');
            const extraFiles = files.length > maxFiles ? `\nâ€¦ì™¸ ${files.length - maxFiles}ê°œ íŒŒì¼` : '';

            // 1024ì ì œí•œ ëŒ€ë¹„ ì˜ë¼ë‚´ê¸°
            const clamp = (s, n=1024) => s.length > n ? s.slice(0, n - 1) + 'â€¦' : s;

            // ìƒì„¸ ë§í¬
            const compareUrl = `${pr.html_url}/files`; // íŒŒì¼ ë³€ê²½ íƒ­
            const commitsUrl = `${pr.html_url}/commits`; // ì»¤ë°‹ íƒ­

            const payload = {
              embeds: [{
                title: "ğŸ›  ì‘ì—… ë‚´ìš© ìš”ì•½",
                description: `[${pr.title}](${pr.html_url})`,
                color: 5793266,
                fields: [
                  {
                    name: "ğŸ§© ì»¤ë°‹ ìš”ì•½",
                    value: clamp(commitLines + extraCommits || "ì»¤ë°‹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
                  },
                  {
                    name: "ğŸ—‚ ë³€ê²½ íŒŒì¼",
                    value: clamp(fileLines + extraFiles || "ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
                  },
                  {
                    name: "ğŸ”— ìì„¸íˆ ë³´ê¸°",
                    value: `[ì»¤ë°‹ ëª©ë¡](${commitsUrl}) | [íŒŒì¼ ë³€ê²½](${compareUrl})`
                  }
                ],
                timestamp: new Date().toISOString()
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # ì—¬ëŸ¬ ë¦¬ë·°ì–´ ë©˜ì…˜ (ì¤‘ë³µ ë°©ì§€ í¬í•¨)
      - name: Mention Reviewers (on review_requested)
        if: github.event_name == 'pull_request' && github.event.action == 'review_requested'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;

            // ìš”ì²­ëœ ì „ì²´ ë¦¬ë·°ì–´ ëª©ë¡ê³¼ í˜„ì¬(íŠ¸ë¦¬ê±°) ë¦¬ë·°ì–´
            const reviewers = (pr.requested_reviewers ?? []).map(u => u.login);
            const current = context.payload.requested_reviewer?.login ?? null;
            const first = reviewers[0] ?? null;

            // ì²« ë²ˆì§¸ ë¦¬ë·°ì–´ë§Œ ì•Œë¦¼ ì „ì†¡ (ì¤‘ë³µ ë°©ì§€)
            if (first && current && current !== first) {
              core.info(`Skip: ${current} is not the first reviewer (${first}).`);
              return;
            }

            // GitHub login -> Discord mention ë§¤í•‘
            const mapMention = (login) => ({
              "chen4023": "<@683563560063991848>",
              "Kwonyeojiny": "<@579296258091646976>",
              "wrongstory": "<@256645987638968320>",
              "minjekim64": "<@595553015990059009>",
              "rlaalsckd4": "<@704883949146472449>",
              "makee-ham": "<@534334882512633862>",
              "shin-minhyuk": "<@1121074841102069814>",
            }[login] ?? `@${login}`);

            // ë©˜ì…˜ ëª©ë¡ (ìš”ì²­ëœ ë¦¬ë·°ì–´ê°€ ì—†ìœ¼ë©´ current ì‚¬ìš©)
            const targetLogins = reviewers.length ? reviewers : (current ? [current] : []);
            if (!targetLogins.length) {
              core.info("No reviewers to notify.");
              return;
            }
            const mentions = targetLogins.map(mapMention).join(" ");

            const payload = {
              content: `ğŸ” **ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!** ${mentions}`,
              embeds: [{
                title: "ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ‘€",
                description: `[${pr.title}](${pr.html_url})`,
                color: 16776960,
                fields: [
                  { name: "ğŸ‘¤ PR ì‘ì„±ì", value: pr.user?.login ?? "unknown", inline: true },
                  { name: "ğŸ“ ë³€ê²½ì‚¬í•­", value: `íŒŒì¼ ${pr.changed_files ?? 0}ê°œ | +${pr.additions ?? 0} -${pr.deletions ?? 0}`, inline: false },
                ],
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # PR ë³‘í•©/ë‹«í˜ ì•Œë¦¼
      - name: Notify on PR Closed
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;

            const merged = !!pr.merged;
            const statusTitle = merged ? "âœ… ë³‘í•© ì™„ë£Œ!" : "âŒ PR ë‹«í˜";
            const emoji = merged ? "ğŸ‰" : "ğŸš«";
            const color = merged ? 65280 : 16711680;

            const payload = {
              embeds: [{
                title: `${emoji} ${statusTitle}`,
                description: `[${pr.title}](${pr.html_url})`,
                color,
                fields: [
                  { name: "ğŸ‘¤ ì‘ì„±ì", value: pr.user?.login ?? "unknown", inline: true },
                  { name: "ğŸŒ¿ ë¸Œëœì¹˜", value: `\`${pr.head.ref}\` â†’ \`${pr.base.ref}\``, inline: true },
                ],
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # ë¦¬ë·° ìŠ¹ì¸ ì•Œë¦¼
      - name: Notify on Review Approved
        if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;
            const review = context.payload.review;

            const mapMention = (login) => ({
              "chen4023": "<@683563560063991848>",
              "Kwonyeojiny": "<@579296258091646976>",
              "wrongstory": "<@256645987638968320>",
              "minjekim64": "<@595553015990059009>",
              "rlaalsckd4": "<@704883949146472449>",
              "makee-ham": "<@534334882512633862>",
              "shin-minhyuk": "<@1121074841102069814>",
            }[login] ?? `@${login}`);

            const authorMention = mapMention(pr.user?.login ?? "unknown");

            const payload = {
              content: `ğŸ‘ **ë¦¬ë·°ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!** ${authorMention}`,
              embeds: [{
                title: "âœ… ë¦¬ë·° ìŠ¹ì¸ ì™„ë£Œ!",
                description: `[${pr.title}](${pr.html_url})`,
                color: 65280,
                fields: [
                  { name: "ğŸ‘€ ë¦¬ë·°ì–´", value: review.user?.login ?? "unknown", inline: true },
                  { name: "ğŸ’¬ ë¦¬ë·° ë‚´ìš©", value: "ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!", inline: false },
                ],
                footer: { text: "ì´ì œ ë³‘í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€" }
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

      # ë³€ê²½ ìš”ì²­ ì•Œë¦¼
      - name: Notify on Changes Requested
        if: github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested'
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const pr = context.payload.pull_request;
            const review = context.payload.review;

            const mapMention = (login) => ({
              "chen4023": "<@683563560063991848>",
              "Kwonyeojiny": "<@579296258091646976>",
              "wrongstory": "<@256645987638968320>",
              "minjekim64": "<@595553015990059009>",
              "rlaalsckd4": "<@704883949146472449>",
              "makee-ham": "<@534334882512633862>",
              "shin-minhyuk": "<@1121074841102069814>",
            }[login] ?? `@${login}`);

            const authorMention = mapMention(pr.user?.login ?? "unknown");

            const payload = {
              content: `ğŸ”„ **ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!** ${authorMention}`,
              embeds: [{
                title: "â— ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤",
                description: `[${pr.title}](${pr.html_url})`,
                color: 16776960,
                fields: [
                  { name: "ğŸ‘€ ë¦¬ë·°ì–´", value: review.user?.login ?? "unknown", inline: true },
                  { name: "ğŸ“ ìš”ì²­ì‚¬í•­", value: "ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ PRì„ í™•ì¸í•´ì£¼ì„¸ìš”.", inline: false },
                ],
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

  ci_summary:
    # CIê°€ ëë‚¬ì„ ë•Œë§Œ ì‹¤í–‰ (ì´ ì›Œí¬í”Œë¡œìš°ëŠ” workflow_runì—ì„œ í˜¸ì¶œë¨)
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    permissions:
      actions: read # runì˜ job ëª©ë¡ ì¡°íšŒ
      contents: read
    steps:
      - name: Post CI Summary to Discord
        uses: actions/github-script@v7
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            const { owner, repo } = context.repo;
            const run = context.payload.workflow_run;

            // CI ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì˜ Jobs ì¡°íšŒ
            const jobsRes = await github.rest.actions.listJobsForWorkflowRun({
              owner, repo, run_id: run.id, per_page: 100
            });
            const jobs = jobsRes.data.jobs || [];

            // ë§¤íŠ¸ë¦­ìŠ¤ Jobë§Œ ì¶”ë ¤ë‚´ê¸° (ì´ë¦„ì— build_test ë˜ëŠ” ci job ì´ë¦„ì´ í¬í•¨)
            const targetJobs = jobs.filter(j => /build_test|build_only|test|build/i.test(j.name));

            // ìƒíƒœ ì´ëª¨ì§€
            const toEmoji = (c) => ({
              success: "âœ…",
              failure: "âŒ",
              cancelled: "ğŸš«",
              timed_out: "â°",
              neutral: "âšª",
              skipped: "â­ï¸",
              action_required: "âš ï¸",
              stale: "ğŸ•“"
            }[String(c || '').toLowerCase()] || "â“");

            // ì‹œê°„/ë§í¬
            const runUrl = run.html_url;
            const branch = run.head_branch;
            const statusEmoji = toEmoji(run.conclusion);
            const title = `${statusEmoji} CI ì™„ë£Œ â€” ${owner}/${repo} @ ${branch}`;
            const when = run.updated_at || run.created_at || new Date().toISOString();

            // ê° Job ìš”ì•½ (ì˜ˆ: build_test / Node 20, build_test / Node 22)
            const lines = targetJobs.map(j => {
              const durMs = (new Date(j.completed_at) - new Date(j.started_at)) || 0;
              const sec = Math.max(1, Math.round(durMs / 1000));
              return `â€¢ ${toEmoji(j.conclusion)} ${j.name} (${sec}s)`;
            });

            // ê´€ë ¨ PR ë§í¬(ìˆìœ¼ë©´)
            const prs = run.pull_requests || [];
            const prLink = prs[0]?.html_url ? `[PR #${prs[0].number}](${prs[0].html_url})` : "í•´ë‹¹ ì—†ìŒ";

            // ë””ìŠ¤ì½”ë“œ ì„ë² ë“œ
            const payload = {
              embeds: [{
                title,
                description: `[Workflow Run ì—´ê¸°](${runUrl})`,
                color: String(run.conclusion).toLowerCase() === 'success' ? 65280 : 16711680, // ì´ˆë¡/ë¹¨ê°•
                fields: [
                  { name: "ëŒ€ìƒ ë¸Œëœì¹˜", value: `\`${branch}\``, inline: true },
                  { name: "ê²°ê³¼", value: String(run.conclusion || 'unknown'), inline: true },
                  { name: "ê´€ë ¨ PR", value: prLink, inline: false },
                  { name: "ë§¤íŠ¸ë¦­ìŠ¤ ê²°ê³¼", value: lines.length ? lines.join('\n') : "ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", inline: false },
                ],
                timestamp: when
              }]
            };

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
