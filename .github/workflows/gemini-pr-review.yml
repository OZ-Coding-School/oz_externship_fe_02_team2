name: Gemini PR Review (fast)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_call:
    inputs:
      full_context:
        description: 'trueë©´ ì „ì²´ ì´ë ¥ + blobless + sparse(src) + PR ì „ì²´ diff(Bì•ˆ), falseë©´ ì–•ì€ í´ë¡  + ë§ˆì§€ë§‰ ì»¤ë°‹ë§Œ(Aì•ˆ)'
        required: false
        default: false
        type: boolean
    secrets:
      GEMINI_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-review:
    runs-on: ubuntu-22.04 # ubuntu-latest ëŒ€ì‹  ê³ ì • ë²„ì „ â†’ í ëŒ€ê¸° ì¤„ì–´ë“¦

    steps:
      # --- Checkout ë¶„ê¸° ---
      - name: Checkout (shallow + blobless) # Aì•ˆ
        if: inputs.full_context == false
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          filter: blob:none

      - name: Checkout (full history + blobless) # Bì•ˆ
        if: inputs.full_context == true
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: blob:none

      # --- ìš°ë¦¬ê°€ ìž‘ì„±í•œ ì½”ë“œë§Œ íŽ¼ì¹˜ê¸°: src ---
      - name: Apply sparse-checkout (cone, src only)
        run: |
          git sparse-checkout init --cone
          git sparse-checkout set src

      - name: Ensure jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      # --- DIFF ìƒì„± ë¶„ê¸° ---
      # Aì•ˆ: ë§ˆì§€ë§‰ ì»¤ë°‹ë§Œ
      - name: Get PR diff (last commit only)
        if: inputs.full_context == false
        run: |
          git diff HEAD^..HEAD --unified=0 | head -c 120000 > changes.diff
          echo "---- DIFF PREVIEW (last commit) ----"
          head -n 50 changes.diff || true
          echo "------------------------------------"

      # Bì•ˆ: PR ì „ì²´ ë§¥ë½ (base SHA ~ HEAD)
      - name: Get PR base SHA (for full-context)
        if: inputs.full_context == true
        id: prbase
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
        run: |
          if [ -z "$PR_NUMBER" ]; then
            echo "PR_NUMBER not found in event payload"; exit 1
          fi
          RESP=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$GH_REPO/pulls/$PR_NUMBER)
          BASE_SHA=$(echo "$RESP" | jq -r '.base.sha')
          HEAD_SHA=$(echo "$RESP" | jq -r '.head.sha')
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

      - name: Get PR diff (full-context base..head)
        if: inputs.full_context == true
        env:
          BASE: ${{ steps.prbase.outputs.base_sha }}
          HEAD: ${{ steps.prbase.outputs.head_sha }}
        run: |
          # í•„ìš”í•œ ë‘ ì§€ì ë§Œ í™•ì‹¤ížˆ ê°€ì ¸ì™€ì„œ diff
          git fetch --no-tags origin $BASE $HEAD
          git diff $BASE..$HEAD --unified=0 | head -c 120000 > changes.diff
          echo "---- DIFF PREVIEW (base..head) ----"
          head -n 50 changes.diff || true
          echo "-----------------------------------"

      - name: Load context files
        id: context
        run: |
          echo "guide<<EOF" >> $GITHUB_OUTPUT
          [ -f GEMINI.md ] && cat GEMINI.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "config<<EOF" >> $GITHUB_OUTPUT
          [ -f .gemini/config.yaml ] && cat .gemini/config.yaml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call Gemini API
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GUIDE: ${{ steps.context.outputs.guide }}
          CONFIG: ${{ steps.context.outputs.config }}
          MODE: ${{ inputs.full_context }}
        run: |
          SUMMARY_FILE=gemini_review.md
          if [ "$MODE" = "true" ]; then
            echo "## ðŸ¤– Gemini Review (full-context)" > "$SUMMARY_FILE"
          else
            echo "## ðŸ¤– Gemini Review (fast)" > "$SUMMARY_FILE"
          fi
          echo "" >> "$SUMMARY_FILE"

          PROMPT=$(cat <<'EOF'
          ë„ˆëŠ” Lecture Admin Platform í”„ë¡œì íŠ¸ë¥¼ ë¦¬ë·°í•˜ëŠ” ì‹œë‹ˆì–´ íƒ€ìž…ìŠ¤í¬ë¦½íŠ¸/ë¦¬ì•¡íŠ¸ ê°œë°œìžì•¼.
          ì•„ëž˜ ë³€ê²½ëœ ì½”ë“œë¥¼ ë¦¬ë·°í•˜ê³ , ë°˜ë“œì‹œ **í•œêµ­ì–´ë¡œ** ë‹µë³€í•´.

          # í”„ë¡œì íŠ¸ ê°€ì´ë“œ
          {{GUIDE}}

          # ì„¤ì •
          {{CONFIG}}

          ë¦¬ë·° ì‹œ ì¤‘ì  ì‚¬í•­:
          - ì •í™•ì„±, íƒ€ìž… ì•ˆì •ì„±, null ì•ˆì „ì„±
          - React Query / Zustand ì‚¬ìš©ë²•, API ê²½ê³„ ì²˜ë¦¬
          - ì ‘ê·¼ì„± (table êµ¬ì¡°, aria, hydration)
          - ë³´ì•ˆ/ê¶Œí•œ(Role ê¸°ë°˜ ì ‘ê·¼ ì œì–´)
          - UI ì¼ê´€ì„± (Tailwind/DaisyUI) ë° ì„±ëŠ¥

          ì¶œë ¥ í˜•ì‹:
          1. âš ï¸ ê³ ìœ„í—˜/ì°¨ë‹¨ ì´ìŠˆ
          2. âš¡ ì¤‘ìœ„í—˜/ì €ìœ„í—˜ ì´ìŠˆ
          3. ðŸ’¡ í•„ìš”í•œ ê²½ìš° ìµœì†Œ ìˆ˜ì • íŒ¨ì¹˜(diff ì½”ë“œë¸”ë¡)

          ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì„¤ëª…í•´ì¤˜.
          EOF
          )

          PROMPT="${PROMPT//'{{GUIDE}}'/$GUIDE}"
          PROMPT="${PROMPT//'{{CONFIG}}'/$CONFIG}"

          DIFF=$(cat changes.diff)
          REQ=$(jq -n --arg p "$PROMPT" --arg d "$DIFF" '{
            contents: [ { parts: [ { text: ($p + "\n\n---\nDIFF:\n" + $d) } ] } ]
          }')

          RESP=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQ")

          echo "$RESP" | jq -r '.candidates[0].content.parts[0].text // "No response."' >> "$SUMMARY_FILE"

          echo "review_path=$SUMMARY_FILE" >> $GITHUB_OUTPUT

      - name: Post or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number || github.event.issue.number }}
          body-file: ${{ steps.review.outputs.review_path }}
          edit-mode: replace
