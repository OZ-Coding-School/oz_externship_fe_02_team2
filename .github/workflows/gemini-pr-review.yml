name: Gemini PR Review (fast)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_call:

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-review:
    runs-on: ubuntu-22.04 # ubuntu-latest ëŒ€ì‹  ê³ ì • ë²„ì „ â†’ í ëŒ€ê¸° ì¤„ì–´ë“¦

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ìµœê·¼ ì»¤ë°‹ 2ê°œë§Œ ë°›ìŒ

      - name: Ensure jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Get PR diff (last commit only)
        run: |
          git diff HEAD^..HEAD --unified=0 | head -c 120000 > changes.diff
          echo "---- DIFF PREVIEW ----"
          head -n 50 changes.diff || true
          echo "----------------------"

      - name: Load context files
        id: context
        run: |
          echo "guide<<EOF" >> $GITHUB_OUTPUT
          [ -f GEMINI.md ] && cat GEMINI.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "config<<EOF" >> $GITHUB_OUTPUT
          [ -f .gemini/config.yaml ] && cat .gemini/config.yaml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call Gemini API
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GUIDE: ${{ steps.context.outputs.guide }}
          CONFIG: ${{ steps.context.outputs.config }}
        run: |
          SUMMARY_FILE=gemini_review.md
          echo "## ğŸ¤– Gemini Review (fast)" > "$SUMMARY_FILE"
          echo "" >> "$SUMMARY_FILE"

          # here-document ì‹œì‘ê³¼ ë í† í°ì„ ë°˜ë“œì‹œ ë§ì¶”ê¸° (EOF/EOF)
          PROMPT=$(cat <<EOF
          ë„ˆëŠ” Lecture Admin Platform í”„ë¡œì íŠ¸ë¥¼ ë¦¬ë·°í•˜ëŠ” ì‹œë‹ˆì–´ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸/ë¦¬ì•¡íŠ¸ ê°œë°œìì•¼.  
          ì•„ë˜ ë³€ê²½ëœ ì½”ë“œë¥¼ ë¦¬ë·°í•˜ê³ , ë°˜ë“œì‹œ **í•œêµ­ì–´ë¡œ** ë‹µë³€í•´.  

          # í”„ë¡œì íŠ¸ ê°€ì´ë“œ
          $GUIDE

          # ì„¤ì •
          $CONFIG

          ë¦¬ë·° ì‹œ ì¤‘ì  ì‚¬í•­:
          - ì •í™•ì„±, íƒ€ì… ì•ˆì •ì„±, null ì•ˆì „ì„±
          - React Query / Zustand ì‚¬ìš©ë²•, API ê²½ê³„ ì²˜ë¦¬
          - ì ‘ê·¼ì„± (table êµ¬ì¡°, aria, hydration)
          - ë³´ì•ˆ/ê¶Œí•œ(Role ê¸°ë°˜ ì ‘ê·¼ ì œì–´)
          - UI ì¼ê´€ì„± (Tailwind/DaisyUI) ë° ì„±ëŠ¥

          ì¶œë ¥ í˜•ì‹:
          1. âš ï¸ ê³ ìœ„í—˜/ì°¨ë‹¨ ì´ìŠˆ
          2. âš¡ ì¤‘ìœ„í—˜/ì €ìœ„í—˜ ì´ìŠˆ
          3. ğŸ’¡ í•„ìš”í•œ ê²½ìš° ìµœì†Œ ìˆ˜ì • íŒ¨ì¹˜(diff ì½”ë“œë¸”ë¡)

          ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì„¤ëª…í•´ì¤˜.
          EOF
          )

          DIFF=$(cat changes.diff)
          REQ=$(jq -n --arg p "$PROMPT" --arg d "$DIFF" '{
            contents: [ { parts: [ { text: ($p + "\n\n---\nDIFF:\n" + $d) } ] } ]
          }')

          RESP=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQ")

          echo "$RESP" | jq -r '.candidates[0].content.parts[0].text // "No response."' >> "$SUMMARY_FILE"

          echo "review_path=$SUMMARY_FILE" >> $GITHUB_OUTPUT

      - name: Post or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-file: ${{ steps.review.outputs.review_path }}
          edit-mode: replace
